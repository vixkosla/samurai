import{Primitive as e,PropertyType as t,Document as n,getBounds as o,Scene as r,BufferUtils as s,Root as i,TextureInfo as a,Texture as c,ExtensionProperty as l,AnimationChannel as g,Accessor as u,PrimitiveTarget as f,MathUtils as m,ImageUtils as p,ComponentTypeToTypedArray as d,TextureChannel as h,Material as A,Node as T,ColorUtils as y,AnimationSampler as E,uuid as S}from"@gltf-transform/core";import{getPixels as M,savePixels as I}from"ndarray-pixels";import{KHRMeshQuantization as w,KHRDracoMeshCompression as b,EXTMeshGPUInstancing as N,EXTMeshoptCompression as R,KHRMaterialsIOR as C,KHRMaterialsSpecular as O,KHRMaterialsPBRSpecularGlossiness as $,EXTTextureWebP as v,EXTTextureAVIF as P,KHRMaterialsUnlit as x}from"@gltf-transform/extensions";import{read as L,KHR_DF_MODEL_ETC1S as z,KHR_DF_MODEL_UASTC as F}from"ktx-parse";import _ from"ndarray";import{lanczos3 as G,lanczos2 as k}from"ndarray-lanczos";function q(){return q=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},q.apply(this,arguments)}function B(e,t){return Object.defineProperty(t,"name",{value:e}),t}function U(e,t,n){return!!e&&e.stack.lastIndexOf(t)<e.stack.lastIndexOf(n)}async function W(e,t,n){if(!e)return null;const o=e.getImage();if(!o)return null;const r=await M(o,e.getMimeType());for(let e=0;e<r.shape[0];++e)for(let t=0;t<r.shape[1];++t)n(r,e,t);const s=await I(r,"image/png");return t.setImage(s).setMimeType("image/png")}function D(t){const n=t.getIndices(),o=t.getAttribute("POSITION");switch(t.getMode()){case e.Mode.POINTS:return o.getCount();case e.Mode.LINES:return n?n.getCount()/2:o.getCount()/2;case e.Mode.LINE_LOOP:return o.getCount();case e.Mode.LINE_STRIP:return o.getCount()-1;case e.Mode.TRIANGLES:return n?n.getCount()/3:o.getCount()/3;case e.Mode.TRIANGLE_STRIP:case e.Mode.TRIANGLE_FAN:return o.getCount()-2;default:throw new Error("Unexpected mode: "+t.getMode())}}class H{constructor(){this._map=new Map}get size(){return this._map.size}has(e){return this._map.has(e)}add(e,t){let n=this._map.get(e);return n||(n=new Set,this._map.set(e,n)),n.add(t),this}get(e){return this._map.get(e)||new Set}keys(){return this._map.keys()}}function j(e,t=2){if(0===e)return"0 Bytes";const n=t<0?0:t,o=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,o)).toFixed(n))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][o]}function V(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function X(e,t){return`${V(e)} → ${V(t)} (${function(e,t,n=2){return(e>t?"–":"+")+(Math.abs(e-t)/e*100).toFixed(n)+"%"}(e,t)})`}function K(e){const t=[];for(const n of e.listAttributes())t.push(n);for(const n of e.listTargets())for(const e of n.listAttributes())t.push(e);return Array.from(new Set(t))}function J(e,t,n){e.swap(t,n);for(const o of e.listTargets())o.swap(t,n)}function Z(e,t){if(null==e&&null==t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function Q(e,t,n){const o=e.getElementSize(),r=e.getCount(),s=e.getArray(),i=s.slice(0,n*o);for(let e=0;e<r;e++)for(let n=0;n<o;n++)i[t[e]*o+n]=s[e*o+n];e.setArray(i)}function Y(e,t=e){const n=t<=65534?new Uint16Array(e):new Uint32Array(e);for(let e=0;e<n.length;e++)n[e]=e;return n}function ee(e){const t=n.fromGraph(e.getGraph()),o=e.getMaterial();return`${t.getRoot().listMaterials().indexOf(o)}|${e.getMode()}|${!!e.getIndices()}|${e.listSemantics().sort().map(t=>{const n=e.getAttribute(t);return`${t}:${n.getElementSize()}:${n.getComponentType()}`}).join("+")}|${e.listTargets().map(t=>t.listSemantics().sort().map(t=>{const n=e.getAttribute(t);return`${t}:${n.getElementSize()}:${n.getComponentType()}`}).join("+")).join("~")}`}function te(e,t){const[n,o]=t,[r,s]=e;if(r<=n&&s<=o)return e;let i=r,a=s;return i>n&&(a=Math.floor(a*(n/i)),i=n),a>o&&(i=Math.floor(i*(o/a)),a=o),[i,a]}const ne="center",oe={pivot:"center"};function re(e=oe){const t=q({},oe,e);return B(ne,e=>{const n=e.getLogger(),r=e.getRoot(),s=r.listAnimations().length>0||r.listSkins().length>0;e.getRoot().listScenes().forEach((i,a)=>{let c;if(n.debug(`${ne}: Scene ${a+1} / ${r.listScenes().length}.`),"string"==typeof t.pivot){const e=o(i);c=[(e.max[0]-e.min[0])/2+e.min[0],(e.max[1]-e.min[1])/2+e.min[1],(e.max[2]-e.min[2])/2+e.min[2]],"above"===t.pivot&&(c[1]=e.max[1]),"below"===t.pivot&&(c[1]=e.min[1])}else c=t.pivot;n.debug(`${ne}: Pivot "${c.join(", ")}".`);const l=[-1*c[0],-1*c[1],-1*c[2]];if(s){n.debug(`${ne}: Model contains animation or skin. Adding a wrapper node.`);const t=e.createNode("Pivot").setTranslation(l);i.listChildren().forEach(e=>t.addChild(e)),i.addChild(t)}else n.debug(`${ne}: Skipping wrapper, offsetting all root nodes.`),i.listChildren().forEach(e=>{const t=e.getTranslation();e.setTranslation([t[0]+l[0],t[1]+l[1],t[2]+l[2]])})}),n.debug(`${ne}: Complete.`)})}function se(e){const t=new Set;let n,o=e;for(;n=o.getParentNode();){if(t.has(n))throw new Error("Circular dependency in scene graph.");t.add(n),o=n}return o.listParents().filter(e=>e instanceof r)}function ie(e){const t=se(e),n=e.getParentNode();if(!n)return e;e.setMatrix(e.getWorldMatrix()),n.removeChild(e);for(const n of t)n.addChild(e);return e}var ae="undefined"!=typeof Float32Array?Float32Array:Array;function ce(e,t){var n=t[0],o=t[1],r=t[2],s=t[3],i=t[4],a=t[5],c=t[6],l=t[7],g=t[8],u=t[9],f=t[10],m=t[11],p=t[12],d=t[13],h=t[14],A=t[15],T=n*a-o*i,y=n*c-r*i,E=n*l-s*i,S=o*c-r*a,M=o*l-s*a,I=r*l-s*c,w=g*d-u*p,b=g*h-f*p,N=g*A-m*p,R=u*h-f*d,C=u*A-m*d,O=f*A-m*h,$=T*O-y*C+E*R+S*N-M*b+I*w;return $?(e[0]=(a*O-c*C+l*R)*($=1/$),e[1]=(r*C-o*O-s*R)*$,e[2]=(d*I-h*M+A*S)*$,e[3]=(f*M-u*I-m*S)*$,e[4]=(c*N-i*O-l*b)*$,e[5]=(n*O-r*N+s*b)*$,e[6]=(h*E-p*I-A*y)*$,e[7]=(g*I-f*E+m*y)*$,e[8]=(i*C-a*N+l*w)*$,e[9]=(o*N-n*C-s*w)*$,e[10]=(p*M-d*E+A*T)*$,e[11]=(u*E-g*M-m*T)*$,e[12]=(a*b-i*R-c*w)*$,e[13]=(n*R-o*b+r*w)*$,e[14]=(d*y-p*S-h*T)*$,e[15]=(g*S-u*y+f*T)*$,e):null}function le(e,t,n){var o=t[0],r=t[1],s=t[2],i=t[3],a=t[4],c=t[5],l=t[6],g=t[7],u=t[8],f=t[9],m=t[10],p=t[11],d=t[12],h=t[13],A=t[14],T=t[15],y=n[0],E=n[1],S=n[2],M=n[3];return e[0]=y*o+E*a+S*u+M*d,e[1]=y*r+E*c+S*f+M*h,e[2]=y*s+E*l+S*m+M*A,e[3]=y*i+E*g+S*p+M*T,e[4]=(y=n[4])*o+(E=n[5])*a+(S=n[6])*u+(M=n[7])*d,e[5]=y*r+E*c+S*f+M*h,e[6]=y*s+E*l+S*m+M*A,e[7]=y*i+E*g+S*p+M*T,e[8]=(y=n[8])*o+(E=n[9])*a+(S=n[10])*u+(M=n[11])*d,e[9]=y*r+E*c+S*f+M*h,e[10]=y*s+E*l+S*m+M*A,e[11]=y*i+E*g+S*p+M*T,e[12]=(y=n[12])*o+(E=n[13])*a+(S=n[14])*u+(M=n[15])*d,e[13]=y*r+E*c+S*f+M*h,e[14]=y*s+E*l+S*m+M*A,e[15]=y*i+E*g+S*p+M*T,e}function ge(){var e=new ae(3);return ae!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function ue(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e}function fe(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e}function me(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function pe(e,t){var n=t[0],o=t[1],r=t[2],s=n*n+o*o+r*r;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function de(e,t,n){var o=t[0],r=t[1],s=t[2],i=n[3]*o+n[7]*r+n[11]*s+n[15];return e[0]=(n[0]*o+n[4]*r+n[8]*s+n[12])/(i=i||1),e[1]=(n[1]*o+n[5]*r+n[9]*s+n[13])/i,e[2]=(n[2]*o+n[6]*r+n[10]*s+n[14])/i,e}function he(e,t,n){var o=t[0],r=t[1],s=t[2];return e[0]=o*n[0]+r*n[3]+s*n[6],e[1]=o*n[1]+r*n[4]+s*n[7],e[2]=o*n[2]+r*n[5]+s*n[8],e}function Ae(){var e=new ae(4);return ae!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),ge(),Ae();const Te="dedup",ye={propertyTypes:[t.ACCESSOR,t.MESH,t.TEXTURE,t.MATERIAL,t.SKIN]};function Ee(e=ye){const n=q({},ye,e),o=new Set(n.propertyTypes);for(const e of n.propertyTypes)if(!ye.propertyTypes.includes(e))throw new Error(`${Te}: Unsupported deduplication on type "${e}".`);return B(Te,e=>{const n=e.getLogger();o.has(t.ACCESSOR)&&function(e){const t=e.getLogger(),n=new Map,o=new Map,r=new Map,i=new Map,a=e.getRoot().listMeshes();a.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(e=>c(e,o)),c(e.getIndices(),n)})});for(const t of e.getRoot().listAnimations())for(const e of t.listSamplers())c(e.getInput(),r),c(e.getOutput(),i);function c(e,t){if(!e)return;const n=[e.getCount(),e.getType(),e.getComponentType(),e.getNormalized(),e.getSparse()].join(":");let o=t.get(n);o||t.set(n,o=new Set),o.add(e)}function l(e,t){for(let n=0;n<e.length;n++){const o=e[n],r=s.toView(o.getArray());if(!t.has(o))for(let i=n+1;i<e.length;i++){const n=e[i];t.has(n)||s.equals(r,s.toView(n.getArray()))&&t.set(n,o)}}}let g=0;const u=new Map;for(const e of[o,n,r,i])for(const t of e.values())g+=t.size,l(Array.from(t),u);t.debug(`${Te}: Merged ${u.size} of ${g} accessors.`),a.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(t=>{u.has(t)&&e.swap(t,u.get(t))});const t=e.getIndices();t&&u.has(t)&&e.swap(t,u.get(t))})});for(const t of e.getRoot().listAnimations())for(const e of t.listSamplers()){const t=e.getInput(),n=e.getOutput();t&&u.has(t)&&e.swap(t,u.get(t)),n&&u.has(n)&&e.swap(n,u.get(n))}Array.from(u.keys()).forEach(e=>e.dispose())}(e),o.has(t.TEXTURE)&&function(e){const t=e.getLogger(),n=e.getRoot(),o=n.listTextures(),r=new Map;for(let e=0;e<o.length;e++){const t=o[e],n=t.getImage();if(!r.has(t))for(let i=e+1;i<o.length;i++){const e=o[i],a=e.getImage();if(r.has(e))continue;if(t.getMimeType()!==e.getMimeType())continue;const c=t.getSize(),l=e.getSize();c&&l&&c[0]===l[0]&&c[1]===l[1]&&n&&a&&s.equals(n,a)&&r.set(e,t)}}t.debug(`${Te}: Merged ${r.size} of ${n.listTextures().length} textures.`),Array.from(r.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof i||n.swap(e,t)}),e.dispose()})}(e),o.has(t.MATERIAL)&&function(e){const t=e.getLogger(),n=e.getRoot().listMaterials(),o=new Map,r=new Set(["name"]),s=new Map;for(let e=0;e<n.length;e++){const t=n[e];if(!o.has(t)&&!Me(t,s))for(let i=e+1;i<n.length;i++){const e=n[i];o.has(e)||Me(e,s)||t.equals(e,r)&&o.set(e,t)}}t.debug(`${Te}: Merged ${o.size} of ${n.length} materials.`),Array.from(o.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof i||n.swap(e,t)}),e.dispose()})}(e),o.has(t.MESH)&&function(e){const n=e.getLogger(),o=e.getRoot(),r=new Map;o.listAccessors().forEach((e,t)=>r.set(e,t)),o.listMaterials().forEach((e,t)=>r.set(e,t));const s=o.listMeshes().length,i=new Map;for(const e of o.listMeshes()){const n=[];for(const t of e.listPrimitives())n.push(Se(t,r));const o=n.join(";");if(i.has(o)){const n=i.get(o);e.listParents().forEach(o=>{o.propertyType!==t.ROOT&&o.swap(e,n)}),e.dispose()}else i.set(o,e)}n.debug(`${Te}: Merged ${s-i.size} of ${s} meshes.`)}(e),o.has(t.SKIN)&&function(e){const t=e.getLogger(),n=e.getRoot().listSkins(),o=new Map,r=new Set(["name","joints"]);for(let e=0;e<n.length;e++){const t=n[e];if(!o.has(t))for(let s=e+1;s<n.length;s++){const e=n[s];o.has(e)||t.equals(e,r)&&Z(t.listJoints(),e.listJoints())&&o.set(e,t)}}t.debug(`${Te}: Merged ${o.size} of ${n.length} skins.`),Array.from(o.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof i||n.swap(e,t)}),e.dispose()})}(e),n.debug(`${Te}: Complete.`)})}function Se(t,n){const o=[];for(const e of t.listSemantics()){const r=t.getAttribute(e);o.push(e+":"+n.get(r))}if(t instanceof e){const e=t.getIndices();e&&o.push("indices:"+n.get(e));const r=t.getMaterial();r&&o.push("material:"+n.get(r)),o.push("mode:"+t.getMode());for(const e of t.listTargets())o.push("target:"+Se(e,n))}return o.join(",")}function Me(e,t){if(t.has(e))return t.get(e);const n=e.getGraph(),o=new Set,r=n.listParentEdges(e);for(;r.length>0;){const s=r.pop();if(!0===s.getAttributes().modifyChild)return t.set(e,!0),!0;const i=s.getChild();if(!o.has(i))for(const e of n.listChildEdges(i))r.push(e)}return t.set(e,!1),!1}function Ie(e){const t=e.getGraph(),n=new Set;for(const o of t.listParentEdges(e)){const e=o.getParent(),r=o.getName()+"Info";for(const o of t.listChildEdges(e)){const e=o.getChild();e instanceof a&&o.getName()===r&&n.add(e)}}return Array.from(n)}function we(e){const t=e.getGraph(),n=new Set,o=new Set;return function e(r){const s=new Set;for(const e of t.listChildEdges(r))e.getChild()instanceof c&&s.add(e.getName()+"Info");for(const i of t.listChildEdges(r)){const t=i.getChild();n.has(t)||(n.add(t),t instanceof a&&s.has(i.getName())?o.add(t):t instanceof l&&e(t))}}(e),Array.from(o)}const be="prune",Ne={propertyTypes:[t.NODE,t.SKIN,t.MESH,t.CAMERA,t.PRIMITIVE,t.PRIMITIVE_TARGET,t.ANIMATION,t.MATERIAL,t.TEXTURE,t.ACCESSOR,t.BUFFER],keepLeaves:!1,keepAttributes:!0};function Re(e=Ne){const n=q({},Ne,e),o=new Set(n.propertyTypes);return B(be,e=>{const s=e.getLogger(),a=e.getRoot(),c=e.getGraph(),l={};if(o.has(t.MESH))for(const e of a.listMeshes())e.listPrimitives().length>0||(e.dispose(),p(e));if(o.has(t.NODE)&&!n.keepLeaves&&a.listScenes().forEach(function e(n){if(n.listChildren().forEach(e),n instanceof r)return;const o=c.listParentEdges(n).some(e=>{const n=e.getParent().propertyType;return n!==t.ROOT&&n!==t.SCENE&&n!==t.NODE});0!==c.listChildren(n).length||o||(n.dispose(),p(n))}),o.has(t.NODE)&&a.listNodes().forEach(u),o.has(t.SKIN)&&a.listSkins().forEach(u),o.has(t.MESH)&&a.listMeshes().forEach(u),o.has(t.CAMERA)&&a.listCameras().forEach(u),o.has(t.PRIMITIVE)&&f(c,t.PRIMITIVE),o.has(t.PRIMITIVE_TARGET)&&f(c,t.PRIMITIVE_TARGET),!n.keepAttributes&&o.has(t.ACCESSOR)){const t=new Map;for(const n of a.listMeshes())for(const o of n.listPrimitives()){const n=o.getMaterial(),r=Ce(o,Oe(e,n));m(o,r),o.listTargets().forEach(e=>m(e,r)),n&&(t.has(n)?t.get(n).add(o):t.set(n,new Set([o])))}for(const[e,n]of t)$e(e,Array.from(n))}if(o.has(t.ANIMATION))for(const e of a.listAnimations()){for(const t of e.listChannels())t.getTargetNode()||(t.dispose(),p(t));if(e.listChannels().length)e.listSamplers().forEach(u);else{const t=e.listSamplers();u(e),t.forEach(u)}}if(o.has(t.MATERIAL)&&a.listMaterials().forEach(u),o.has(t.TEXTURE)&&a.listTextures().forEach(u),o.has(t.ACCESSOR)&&a.listAccessors().forEach(u),o.has(t.BUFFER)&&a.listBuffers().forEach(u),Object.keys(l).length){const e=Object.keys(l).map(e=>`${e} (${l[e]})`).join(", ");s.info(`${be}: Removed types... ${e}`)}else s.info(`${be}: No unused properties found.`);function u(e){e.listParents().filter(e=>!(e instanceof i||e instanceof g)).length||(e.dispose(),p(e))}function f(e,t){e.listEdges().map(e=>e.getParent()).filter(e=>e.propertyType===t).forEach(u)}function m(e,t){for(const n of t)e.setAttribute(n,null)}function p(e){l[e.propertyType]=l[e.propertyType]||0,l[e.propertyType]++}s.debug(`${be}: Complete.`)})}function Ce(e,t){const n=[];for(const o of e.listSemantics())"TANGENT"!==o||t.has(o)?(o.startsWith("TEXCOORD_")&&!t.has(o)||o.startsWith("COLOR_")&&"COLOR_0"!==o)&&n.push(o):n.push(o);return n}function Oe(e,t,n=new Set){if(!t)return n;const o=e.getGraph().listChildEdges(t),r=new Set;for(const e of o)e.getChild()instanceof c&&r.add(e.getName());for(const t of o){const o=t.getName(),s=t.getChild();s instanceof a&&r.has(o.replace(/Info$/,""))&&n.add(`TEXCOORD_${s.getTexCoord()}`),s instanceof c&&o.match(/normalTexture/i)&&n.add("TANGENT"),s instanceof l&&Oe(e,s,n)}return n}function $e(e,t){const n=we(e),o=new Set(n.map(e=>e.getTexCoord())),r=Array.from(o).sort(),s=new Map(r.map((e,t)=>[e,t])),i=new Map(r.map((e,t)=>[`TEXCOORD_${e}`,`TEXCOORD_${t}`]));for(const e of n){const t=e.getTexCoord();e.setTexCoord(s.get(t))}for(const e of t){const t=e.listSemantics().filter(e=>e.startsWith("TEXCOORD_")).sort();a(e,t),e.listTargets().forEach(e=>a(e,t))}function a(e,t){for(const n of t){const t=e.getAttribute(n);if(!t)continue;const o=i.get(n);o!==n&&(e.setAttribute(o,t),e.setAttribute(n,null))}}}const ve="weld",Pe={DEFAULT:1e-4,TEXCOORD:1e-4,COLOR:.01,NORMAL:.05,JOINTS:0,WEIGHTS:.01},xe={tolerance:Pe.DEFAULT,toleranceNormal:Pe.NORMAL,overwrite:!0,exhaustive:!1};function Le(e=xe){const n=De(e);return B(ve,async e=>{const o=e.getLogger();for(const t of e.getRoot().listMeshes()){for(const o of t.listPrimitives())ze(e,o,n),0===o.getIndices().getCount()&&o.dispose();0===t.listPrimitives().length&&t.dispose()}n.tolerance>0&&await e.transform(Re({propertyTypes:[t.ACCESSOR,t.NODE]})),await e.transform(Ee({propertyTypes:[t.ACCESSOR]})),o.debug(`${ve}: Complete.`)})}function ze(t,o=xe,r=xe){let s,i,a;if(t instanceof e){const e=t.getGraph();s=n.fromGraph(e),i=t,a=De(o)}else s=t,i=o,a=De(r);i.getIndices()&&!a.overwrite||i.getMode()!==e.Mode.POINTS&&(0===a.tolerance?function(e,t){if(t.getIndices())return;const n=t.listAttributes()[0],o=n.getCount(),r=n.getBuffer(),s=e.createAccessor().setBuffer(r).setType(u.Type.SCALAR).setArray(Y(o));t.setIndices(s)}(s,i):function(e,t,n){const o=e.getLogger(),r=t.getAttribute("POSITION"),s=t.getIndices()||e.createAccessor().setArray(Y(r.getCount())),i=new Uint32Array(new Set(s.getArray())).sort(),a={};for(const e of t.listSemantics()){const o=t.getAttribute(e);a[e]=ke(e,o,n)}var c;o.debug(`${ve}: Tolerance thresholds: ${c=a,Object.entries(c).map(([e,t])=>`${e}=${t}`).join(", ")}`);const l=[0,0,0],g=[0,0,0],u={},f=a.POSITION;for(let e=0;e<i.length;e++){r.getElement(i[e],l);const t=We(l,f);u[t]=u[t]||[],u[t].push(i[e])}const m=Y(i[i.length-1]+1),p=new Array(i.length).fill(-1),d=r.getCount();let h=0;for(let e=0;e<i.length;e++){const o=i[e];r.getElement(o,l);const s=n.exhaustive?Ue(l,f):[We(l,f)];e:for(const e of s)if(u[e])t:for(const n of u[e]){const e=m[n];if(o<=e)continue t;r.getElement(e,g);const s=t.listSemantics().every(n=>qe(t.getAttribute(n),o,e,a[n])),i=t.listTargets().every(t=>t.listSemantics().every(n=>qe(t.getAttribute(n),o,e,a[n])));if(s&&i){m[o]=e;break e}}p[o]=m[o]===o?h++:p[m[o]]}o.debug(`${ve}: ${X(d,h)} vertices.`);const A=s.getCount(),T=Y(A,i.length);for(let e=0;e<A;e++)T[e]=p[s.getScalar(e)];t.setIndices(s.clone().setArray(T)),1===s.listParents().length&&s.dispose();for(const e of t.listAttributes())Fe(t,e,p,h);for(const e of t.listTargets())for(const t of e.listAttributes())Fe(e,t,p,h);!function(e){const t=e.getIndices();if(!t)return;const n=[];let o=-Infinity;for(let e=0,r=t.getCount();e<r;e+=3){const r=t.getScalar(e),s=t.getScalar(e+1),i=t.getScalar(e+2);r!==s&&r!==i&&s!==i&&(n.push(r,s,i),o=Math.max(o,r,s,i))}const r=Y(n.length,o);r.set(n),t.setArray(r)}(t)}(s,i,a))}function Fe(e,t,n,o){const r=(s=t.getArray(),i=o*t.getElementSize(),new(0,s.constructor)(i));var s,i;const a=t.clone().setArray(r),c=new Uint8Array(o);for(let e=0,o=[];e<n.length;e++)c[n[e]]||(a.setElement(n[e],t.getElement(e,o)),c[n[e]]=1);e.swap(t,a),1===t.listParents().length&&t.dispose()}const _e=[],Ge=[];function ke(e,t,n){if("NORMAL"===e||"TANGENT"===e)return n.toleranceNormal;if(e.startsWith("COLOR_"))return Pe.COLOR;if(e.startsWith("TEXCOORD_"))return Pe.TEXCOORD;if(e.startsWith("JOINTS_"))return Pe.JOINTS;if(e.startsWith("WEIGHTS_"))return Pe.WEIGHTS;_e.length=Ge.length=0,t.getMinNormalized(_e),t.getMaxNormalized(Ge);const o=Ge.map((e,t)=>e-_e[t]),r=Math.max(...o);return n.tolerance*r}function qe(e,t,n,o,r){e.getElement(t,_e),e.getElement(n,Ge);for(let t=0,n=e.getElementSize();t<n;t++)if(Math.abs(_e[t]-Ge[t])>o)return!1;return!0}const Be=[0,-1,1];function Ue(e,t){const n=[],o=[0,0,0];for(const r of Be)for(const s of Be)for(const i of Be)o[0]=e[0]+r*t,o[1]=e[1]+s*t,o[2]=e[2]+i*t,n.push(We(o,t));return n}function We(e,t){return Math.round(e[0]/t)+":"+Math.round(e[1]/t)+":"+Math.round(e[2]/t)}function De(e){const t=q({},xe,e);if(t.tolerance<0||t.tolerance>.1)throw new Error(`${ve}: Requires 0 ≤ tolerance ≤ 0.1`);if(t.toleranceNormal<0||t.toleranceNormal>Math.PI/2)throw new Error(`${ve}: Requires 0 ≤ toleranceNormal ≤ ${(Math.PI/2).toFixed(2)}`);return t.tolerance>0&&(t.tolerance=Math.max(t.tolerance,Number.EPSILON),t.toleranceNormal=Math.max(t.toleranceNormal,Number.EPSILON)),t}function He(t,n,o=new Set){var r;const s=t.getAttribute("POSITION"),i=(null==(r=t.getIndices())?void 0:r.getArray())||Y(s.getCount());s&&je(n,s,i,new Set(o));const a=t.getAttribute("NORMAL");a&&Ve(n,a,i,new Set(o));const c=t.getAttribute("TANGENT");c&&Xe(n,c,i,new Set(o));for(const e of t.listTargets()){const t=e.getAttribute("POSITION");t&&je(n,t,i,new Set(o));const r=e.getAttribute("NORMAL");r&&Ve(n,r,i,new Set(o));const s=e.getAttribute("TANGENT");s&&Xe(n,s,i,new Set(o))}var l,g,u,f,m,p,d,h,A,T,y,E,S,M,I,w,b;((g=(l=n)[0])*(d=l[5])-(u=l[1])*(p=l[4]))*((E=l[10])*(b=l[15])-(S=l[11])*(w=l[14]))-(g*(h=l[6])-(f=l[2])*p)*((y=l[9])*b-S*(I=l[13]))+(g*(A=l[7])-(m=l[3])*p)*(y*w-E*I)+(u*h-f*d)*((T=l[8])*b-S*(M=l[12]))-(u*A-m*d)*(T*w-E*M)+(f*A-m*h)*(T*I-y*M)<0&&function(t){if(t.getMode()!==e.Mode.TRIANGLES)return;t.getIndices()||ze(t,{tolerance:0});const n=t.getIndices();for(let e=0,t=n.getCount();e<t;e+=3){const t=n.getScalar(e),o=n.getScalar(e+2);n.setScalar(e,o),n.setScalar(e+2,t)}}(t);for(let e=0;e<i.length;e++)o.add(i[e])}function je(e,t,n,o){const r=new Float32Array(3*t.getCount()),s=t.getElementSize();for(let e=0,n=[],o=t.getCount();e<o;e++)r.set(t.getElement(e,n),e*s);const i=ge();for(let s=0;s<n.length;s++){const a=n[s];o.has(a)||(t.getElement(a,i),de(i,i,e),r.set(i,3*a),o.add(a))}t.setArray(r).setNormalized(!1)}function Ve(e,t,n,o){const r=(s=new ae(9),ae!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s);var s;!function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]}(r,e),function(e,t){var n=t[0],o=t[1],r=t[2],s=t[3],i=t[4],a=t[5],c=t[6],l=t[7],g=t[8],u=g*i-a*l,f=-g*s+a*c,m=l*s-i*c,p=n*u+o*f+r*m;p&&(e[0]=u*(p=1/p),e[1]=(-g*o+r*l)*p,e[2]=(a*o-r*i)*p,e[3]=f*p,e[4]=(g*n-r*c)*p,e[5]=(-a*n+r*s)*p,e[6]=m*p,e[7]=(-l*n+o*c)*p,e[8]=(i*n-o*s)*p)}(r,r),function(e,t){if(e===t){var n=t[1],o=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=o,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(r,r);const i=ge();for(let e=0;e<n.length;e++){const s=n[e];o.has(s)||(t.getElement(s,i),he(i,i,r),pe(i,i),t.setElement(s,i),o.add(s))}}function Xe(e,t,n,o){const r=ge(),s=Ae();for(let i=0;i<n.length;i++){const a=n[i];if(o.has(a))continue;t.getElement(a,s);const[c,l,g]=s;r[0]=e[0]*c+e[4]*l+e[8]*g,r[1]=e[1]*c+e[5]*l+e[9]*g,r[2]=e[2]*c+e[6]*l+e[10]*g,pe(r,r),s[0]=r[0],s[1]=r[1],s[2]=r[2],t.setElement(a,s),o.add(a)}}function Ke(n,o,r=!1,s){for(const e of n.listPrimitives())if(e.listParents().some(e=>e.propertyType===t.MESH&&e!==n)){const t=e.clone();n.swap(e,t);for(const e of t.listTargets()){const n=e.clone();t.swap(e,n)}}if(!r){const t=new Set([...n.listPrimitives(),...n.listPrimitives().flatMap(e=>e.listTargets())]),o=new Map;for(const r of n.listPrimitives())for(const n of K(r))n.listParents().some(n=>(n instanceof e||n instanceof f)&&!t.has(n))&&!o.has(n)&&o.set(n,n.clone());for(const e of t)for(const[t,n]of o)e.swap(t,n)}const i=new Map;for(const e of n.listPrimitives()){const t=e.getAttribute("POSITION");let n;s?n=s:i.has(t)?n=i.get(t):i.set(t,n=new Set),He(e,o,n)}}const Je=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function Ze(e){const t=e.getMesh(),n=e.getMatrix();t&&!m.eq(n,Je)&&Ke(t,n);for(const t of e.listChildren()){const e=t.getMatrix();le(e,e,n),t.setMatrix(e)}return e.setMatrix(Je)}const Qe="dequantize",Ye={pattern:/^((?!JOINTS_).)*$/};function et(e=Ye){const t=q({},Ye,e);return B(Qe,e=>{const n=e.getLogger();for(const n of e.getRoot().listMeshes())for(const e of n.listPrimitives())tt(e,t);e.createExtension(w).dispose(),n.debug(`${Qe}: Complete.`)})}function tt(e,t){for(const n of e.listSemantics())nt(n,e.getAttribute(n),t);for(const n of e.listTargets())for(const e of n.listSemantics())nt(e,n.getAttribute(e),t)}function nt(e,t,n){if(!t.getArray())return;if(!n.pattern.test(e))return;if(t.getComponentSize()>=4)return;const o=t.getArray(),r=new Float32Array(o.length);for(let e=0,n=t.getCount(),s=[];e<n;e++)s=t.getElement(e,s),t.setArray(r).setElement(e,s).setArray(o);t.setArray(r).setNormalized(!1)}const ot={method:"edgebreaker",encodeSpeed:5,decodeSpeed:5,quantizePosition:14,quantizeNormal:10,quantizeColor:8,quantizeTexcoord:12,quantizeGeneric:12,quantizationVolume:"mesh"};function rt(e=ot){const t=q({},ot,e);return B("draco",async e=>{await e.transform(Le({tolerance:0})),e.createExtension(b).setRequired(!0).setEncoderOptions({method:"edgebreaker"===t.method?b.EncoderMethod.EDGEBREAKER:b.EncoderMethod.SEQUENTIAL,encodeSpeed:t.encodeSpeed,decodeSpeed:t.decodeSpeed,quantizationBits:{POSITION:t.quantizePosition,NORMAL:t.quantizeNormal,COLOR:t.quantizeColor,TEX_COORD:t.quantizeTexcoord,GENERIC:t.quantizeGeneric},quantizationVolume:t.quantizationVolume})})}const st="flatten",it={};function at(e=it){return q({},it,e),B(st,async e=>{const n=e.getRoot(),o=e.getLogger(),r=new Set;for(const e of n.listSkins())for(const t of e.listJoints())r.add(t);const s=new Set;for(const e of n.listAnimations())for(const t of e.listChannels()){const e=t.getTargetNode();e&&s.add(e)}const i=new Set,a=new Set;for(const e of n.listScenes())e.traverse(e=>{const t=e.getParentNode();t&&((r.has(t)||i.has(t))&&i.add(e),(s.has(t)||a.has(t))&&a.add(e))});for(const e of n.listScenes())e.traverse(e=>{s.has(e)||i.has(e)||a.has(e)||ie(e)});s.size&&o.debug(`${st}: Flattening node hierarchies with TRS animation not yet supported.`),await e.transform(Re({propertyTypes:[t.NODE],keepLeaves:!1})),o.debug(`${st}: Complete.`)})}function ct(e){return se(e)[0]||null}const lt=/color|emissive|diffuse/i;function gt(e){return e.getGraph().listParentEdges(e).some(e=>e.getAttributes().isColor||lt.test(e.getName()))?"srgb":null}function ut(e){return{scenes:ft(e),meshes:mt(e),materials:pt(e),textures:dt(e),animations:ht(e)}}function ft(e){return{properties:e.getRoot().listScenes().map(e=>{const t=e.listChildren()[0],n=o(e);return{name:e.getName(),rootName:t?t.getName():"",bboxMin:yt(n.min),bboxMax:yt(n.max)}})}}function mt(e){return{properties:e.getRoot().listMeshes().map(e=>{const n=e.listParents().filter(e=>e.propertyType!==t.ROOT).length;let o=0,r=0;const s=new Set,i=new Set,a=new Set;e.listPrimitives().forEach(e=>{for(const t of e.listSemantics()){const n=e.getAttribute(t);s.add(t+":"+Et(n)),a.add(n)}for(const t of e.listTargets())t.listAttributes().forEach(e=>a.add(e));const t=e.getIndices();t&&(i.add(Et(t)),a.add(t)),r+=e.listAttributes()[0].getCount(),o+=D(e)});let c=0;Array.from(a).forEach(e=>c+=e.getArray().byteLength);const l=e.listPrimitives().map(e=>At[e.getMode()]);return{name:e.getName(),mode:Array.from(new Set(l)),primitives:e.listPrimitives().length,glPrimitives:o,vertices:r,indices:Array.from(i).sort(),attributes:Array.from(s).sort(),instances:n,size:c}})}}function pt(e){return{properties:e.getRoot().listMaterials().map(n=>{const o=n.listParents().filter(e=>e.propertyType!==t.ROOT).length,r=new Set(n.listExtensions()),s=e.getGraph().listEdges().filter(e=>{const t=e.getChild(),o=e.getParent();return t instanceof c&&o===n||!!(t instanceof c&&o instanceof l&&r.has(o))}).map(e=>e.getName());return{name:n.getName(),instances:o,textures:s,alphaMode:n.getAlphaMode(),doubleSided:n.getDoubleSided()}})}}function dt(e){return{properties:e.getRoot().listTextures().map(n=>{const o=n.listParents().filter(e=>e.propertyType!==t.ROOT).length,r=e.getGraph().listParentEdges(n).filter(e=>e.getParent().propertyType!==t.ROOT).map(e=>e.getName()),s=p.getSize(n.getImage(),n.getMimeType());let i="";if("image/ktx2"===n.getMimeType()){const e=L(n.getImage()).dataFormatDescriptor[0];e.colorModel===z?i="ETC1S":e.colorModel===F&&(i="UASTC")}return{name:n.getName(),uri:n.getURI(),slots:Array.from(new Set(r)),instances:o,mimeType:n.getMimeType(),compression:i,resolution:s?s.join("x"):"",size:n.getImage().byteLength,gpuSize:p.getVRAMByteLength(n.getImage(),n.getMimeType())}})}}function ht(e){return{properties:e.getRoot().listAnimations().map(e=>{let t=Infinity,n=-Infinity;e.listSamplers().forEach(e=>{const o=e.getInput();o&&(t=Math.min(t,o.getMin([])[0]),n=Math.max(n,o.getMax([])[0]))});let o=0,r=0;const s=new Set;return e.listSamplers().forEach(e=>{const t=e.getInput(),n=e.getOutput();t&&(r+=t.getCount(),s.add(t),n&&s.add(n))}),Array.from(s).forEach(e=>{o+=e.getArray().byteLength}),{name:e.getName(),channels:e.listChannels().length,samplers:e.listSamplers().length,duration:Math.round(1e3*(n-t))/1e3,keyframes:r,size:o}})}}const At=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"],Tt={Float32Array:"f32",Uint32Array:"u32",Uint16Array:"u16",Uint8Array:"u8",Int32Array:"i32",Int16Array:"i16",Int8Array:"i8"};function yt(e){for(let t=0;t<e.length;t++)e[t].toFixed&&(e[t]=Number(e[t].toFixed(5)));return e}function Et(e){const t=e.getArray();return(Tt[t.constructor.name]||"?")+(e.getNormalized()?"_norm":"")}const St="instance",Mt={min:2};function It(e=Mt){const t=q({},Mt,e);return B(St,e=>{const n=e.getLogger(),o=e.getRoot();if(o.listAnimations().length)return n.warn(`${St}: Instancing is not currently supported for animated models.`),void n.debug(`${St}: Complete.`);const r=e.createExtension(N);let s=0,i=0;for(const a of o.listScenes()){const o=new Map;a.traverse(e=>{const t=e.getMesh();t&&o.set(t,(o.get(t)||new Set).add(e))});const c=[];for(const l of Array.from(o.keys())){const g=Array.from(o.get(l));if(g.length<t.min)continue;if(g.some(e=>e.getSkin()))continue;if(l.listPrimitives().some(bt)&&g.some(Nt))continue;const u=Rt(e,r,l,g.length),f=u.getAttribute("TRANSLATION"),p=u.getAttribute("ROTATION"),d=u.getAttribute("SCALE"),h=e.createNode().setMesh(l).setExtension("EXT_mesh_gpu_instancing",u);a.addChild(h);let A=!1,T=!1,y=!1;for(let e=0;e<g.length;e++){let t,n,o;const r=g[e];f.setElement(e,t=r.getWorldTranslation()),p.setElement(e,n=r.getWorldRotation()),d.setElement(e,o=r.getWorldScale()),m.eq(t,[0,0,0])||(A=!0),m.eq(n,[0,0,0,1])||(T=!0),m.eq(o,[1,1,1])||(y=!0),r.setMesh(null),c.push(r)}A||f.dispose(),T||p.dispose(),y||d.dispose(),wt(c,n),s++,i+=g.length}}n.info(s>0?`${St}: Created ${s} batches, with ${i} total instances.`:`${St}: No meshes with ≥${t.min} parent nodes were found.`),0===r.listProperties().length&&r.dispose(),n.debug(`${St}: Complete.`)})}function wt(e,t){let n,o=0;for(;n=e.pop();){if(n.listChildren().length||n.getCamera()||n.getMesh()||n.getSkin()||n.listExtensions().length)continue;const t=n.getParentNode();t&&e.push(t),n.dispose(),o++}t.debug(`${St}: Removed ${o} unused nodes.`)}function bt(e){const t=e.getMaterial();return!(!t||!t.getExtension("KHR_materials_volume"))}function Nt(e){const t=e.getWorldScale();return!m.eq(t,[1,1,1])}function Rt(e,t,n,o){const r=n.listPrimitives()[0].getAttribute("POSITION").getBuffer(),s=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*o)).setBuffer(r),i=e.createAccessor().setType("VEC4").setArray(new Float32Array(4*o)).setBuffer(r),a=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*o)).setBuffer(r);return t.createInstancedMesh().setAttribute("TRANSLATION",s).setAttribute("ROTATION",i).setAttribute("SCALE",a)}const Ct={skipValidation:!1};function Ot(e,t={}){t=q({},Ct,t);const o=e[0],r=n.fromGraph(o.getGraph());if(!t.skipValidation&&new Set(e.map(ee)).size>1)throw new Error("Requires ≥2 Primitives, sharing the same Material and Mode, with compatible vertex attributes and indices.");const s=[],i=[];let a=0,c=0;for(const t of e){const e=$t(t),n=[];for(let t=0;t<e.length;t++){const o=e[t];void 0===n[o]&&(n[o]=a++),c++}s.push(new Uint32Array(n)),i.push(e)}const l=r.createPrimitive().setMode(o.getMode()).setMaterial(o.getMaterial());for(const e of o.listSemantics()){const t=o.getAttribute(e),n=d[t.getComponentType()],s=r.createAccessor().setType(t.getType()).setBuffer(t.getBuffer()).setNormalized(t.getNormalized()).setArray(new n(a*t.getElementSize()));l.setAttribute(e,s)}const g=(o.getIndices()?Y(a):null)&&r.createAccessor().setBuffer(o.getIndices().getBuffer()).setArray(Y(c,a));l.setIndices(g);let u=0;for(let t=0;t<s.length;t++){const n=e[t],o=s[t],r=i[t],a=u;let c=a;for(const e of l.listSemantics()){const t=n.getAttribute(e),s=l.getAttribute(e),i=[];c=a;for(let e=0;e<r.length;e++){const n=r[e];t.getElement(n,i),s.setElement(o[n],i),g&&g.setScalar(c++,o[n])}}u=c}return l}function $t(e){const t=e.getIndices();return t?t.getArray():Y(e.getAttribute("POSITION").getCount())}const vt="join",{ROOT:Pt,NODE:xt,MESH:Lt,PRIMITIVE:zt,ACCESSOR:Ft}=t,_t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Gt={keepMeshes:!1,keepNamed:!1};function kt(e=Gt){const t=q({},Gt,e);return B(vt,async e=>{const n=e.getRoot(),o=e.getLogger();for(const o of n.listScenes())qt(e,o,t),o.traverse(n=>qt(e,n,t));await e.transform(Re({propertyTypes:[xt,Lt,zt,Ft],keepLeaves:!1,keepAttributes:!0})),o.debug(`${vt}: Complete.`)})}function qt(e,n,o){const r=e.getLogger(),s={},i=n.listChildren();for(let e=0;e<i.length;e++){const t=i[e];if(t.listParents().some(e=>e instanceof g))continue;const n=t.getMesh();if(n&&!t.getExtension("EXT_mesh_gpu_instancing")&&!t.getSkin())for(const r of n.listPrimitives()){if(r.listTargets().length>0)continue;const i=r.getMaterial();if(i&&i.getExtension("KHR_materials_volume"))continue;Wt(r);let a=ee(r);const c=n.getName()||t.getName();(o.keepMeshes||o.keepNamed&&c)&&(a+=`|${e}`),a in s||(s[a]={prims:[],primMeshes:[],primNodes:[],dstNode:t,dstMesh:void 0});const l=s[a];l.prims.push(r),l.primNodes.push(t)}}const a=Object.values(s).filter(({prims:e})=>e.length>1),c=new Set(a.flatMap(e=>e.primNodes));for(const e of c){const t=e.getMesh(),n=t.listParents().some(t=>t.propertyType!==Pt&&e!==t);n&&e.setMesh(t.clone())}for(const e of a){const{dstNode:t,primNodes:n}=e;e.dstMesh=t.getMesh(),e.primMeshes=n.map(e=>e.getMesh())}for(const e of a){const{prims:n,primNodes:o,primMeshes:s,dstNode:i,dstMesh:a}=e,c=i.getMatrix();for(let e=0;e<n.length;e++){const r=o[e];let a=n[e];s[e].removePrimitive(a),(a.listParents().some(e=>e.propertyType!==t.ROOT)||Ut(a))&&(a=n[e]=Bt(n[e])),r!==i&&(le(_t,ce(_t,c),r.getMatrix()),He(a,_t))}const l=Ot(n),g=l.listAttributes()[0].getCount();a.addPrimitive(l),r.debug(`${vt}: Joined Primitives (${n.length}) containing ${V(g)} vertices under Node "${i.getName()}".`)}}function Bt(e){const t=e.clone();for(const e of t.listSemantics())t.setAttribute(e,t.getAttribute(e).clone());const n=t.getIndices();return n&&t.setIndices(n.clone()),t}function Ut(e){for(const t of e.listAttributes())for(const n of t.listParents())if(n!==e&&n.propertyType!==Pt)return!0;return!1}function Wt(e){for(const t of["POSITION","NORMAL","TANGENT"]){const n=e.getAttribute(t);n&&n.getComponentSize()<4&&nt(t,n,{pattern:/.*/})}}function Dt(e){const t=Ht(e),n=[];return t&h.R&&n.push(h.R),t&h.G&&n.push(h.G),t&h.B&&n.push(h.B),t&h.A&&n.push(h.A),n}function Ht(e){const o=n.fromGraph(e.getGraph());let r=0;for(const n of o.getGraph().listParentEdges(e)){const e=n.getParent();let{channels:s}=n.getAttributes();s&&"baseColorTexture"===n.getName()&&e instanceof A&&e.getAlphaMode()===A.AlphaMode.OPAQUE&&(s&=~h.A),s?r|=s:e.propertyType!==t.ROOT&&o.getLogger().warn(`Missing attribute ".channels" on edge, "${n.getName()}".`)}return r}function jt(e){const t=n.fromGraph(e.getGraph()).getRoot(),o=e.getGraph().listParentEdges(e).filter(e=>e.getParent()!==t).map(e=>e.getName());return Array.from(new Set(o))}const Vt="reorder",Xt={target:"size"};function Kt(n){const o=q({},Xt,n),r=o.encoder;if(!r)throw new Error(`${Vt}: encoder dependency required — install "meshoptimizer".`);return B(Vt,async n=>{const s=n.getLogger();await r.ready;const i=function(e){const t=new H,n=new Map,o=new H;for(const r of e.getRoot().listMeshes())for(const e of r.listPrimitives()){const r=e.getIndices();if(r){n.set(r,e.getMode());for(const n of K(e))t.add(r,n),o.add(n,e)}}return{indicesToAttributes:t,indicesToMode:n,attributesToPrimitives:o}}(n);for(const t of i.indicesToAttributes.keys()){const n=t.clone();let s=n.getArray().slice();s instanceof Uint32Array||(s=new Uint32Array(s));const[a,c]=r.reorderMesh(s,i.indicesToMode.get(t)===e.Mode.TRIANGLES,"size"===o.target);n.setArray(c<=65534?new Uint16Array(s):s);for(const e of i.indicesToAttributes.get(t)){const o=e.clone();Q(o,a,c);for(const r of i.attributesToPrimitives.get(e))if(r.getIndices()===t&&r.swap(t,n),r.getIndices()===n){r.swap(e,o);for(const t of r.listTargets())t.swap(e,o)}}}await n.transform(Re({propertyTypes:[t.ACCESSOR]})),i.indicesToAttributes.size?s.debug(`${Vt}: Complete.`):s.warn(`${Vt}: No qualifying primitives found; may need to weld first.`)})}function Jt(e,t=Infinity){if(Number.isFinite(t)&&t%4||t<=0)throw new Error("Limit must be positive multiple of four.");const n=e.getAttribute("POSITION").getCount(),o=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,r=new Uint16Array(4*o),s=new Float32Array(4*o),i=new Float32Array(4*o),a=new Uint32Array(4*o),c=new Uint32Array(4*o);for(let t=0;t<n;t++){Zt(e,t,"WEIGHTS",s),Zt(e,t,"JOINTS",a);for(let e=0;e<4*o;e++)r[e]=e;r.sort((e,t)=>s[e]>s[t]?-1:1);for(let e=0;e<r.length;e++)i[e]=s[r[e]],c[e]=a[r[e]];Qt(e,t,"WEIGHTS",i),Qt(e,t,"JOINTS",c)}for(let n=o;4*n>t;n--){const t=e.getAttribute("WEIGHTS_"+(n-1)),o=e.getAttribute("JOINTS_"+(n-1));e.setAttribute("WEIGHTS_"+(n-1),null),e.setAttribute("JOINTS_"+(n-1),null),1===t.listParents().length&&t.dispose(),1===o.listParents().length&&o.dispose()}!function(e){if(!function(e){const t=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).map(t=>e.getAttribute(t)),n=t.map(e=>e.getNormalized()),o=t.map(e=>e.getComponentType());return 1===new Set(n).size&&1===new Set(o).size}(e))return;const t=e.getAttribute("POSITION").getCount(),n=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,o=e.getAttribute("WEIGHTS_0"),r=o.getArray(),s=o.getComponentType(),i=o.getNormalized(),a=i?s:void 0,c=i?m.decodeNormalizedInt(1,s):Number.EPSILON,l=new Uint32Array(4*n).fill(0),g=r.slice(0,4*n).fill(0);for(let n=0;n<t;n++){Zt(e,n,"JOINTS",l),Zt(e,n,"WEIGHTS",g,a);let t=Yt(g,a);if(0!==t){if(Math.abs(1-t)>c)for(let e=0;e<g.length;e++)if(i){const n=m.encodeNormalizedInt(g[e]/t,s);g[e]=m.decodeNormalizedInt(n,s)}else g[e]/=t;if(t=Yt(g,a),i&&1!==t)for(let e=g.length-1;e>=0;e--)if(g[e]>0){g[e]+=m.encodeNormalizedInt(1-t,s);break}for(let e=g.length-1;e>=0;e--)0===g[e]&&(l[e]=0);Qt(e,n,"JOINTS",l),Qt(e,n,"WEIGHTS",g,a)}}}(e)}function Zt(e,t,n,o,r){let s;const i=[0,0,0,0];for(let a=0;s=e.getAttribute(`${n}_${a}`);a++){s.getElement(t,i);for(let e=0;e<4;e++)o[4*a+e]=r?m.encodeNormalizedInt(i[e],r):i[e]}return o}function Qt(e,t,n,o,r){let s;const i=[0,0,0,0];for(let a=0;s=e.getAttribute(`${n}_${a}`);a++){for(let e=0;e<4;e++)i[e]=r?m.decodeNormalizedInt(o[4*a+e],r):o[4*a+e];s.setElement(t,i)}}function Yt(e,t){let n=0;for(let o=0;o<e.length;o++)n+=t?m.decodeNormalizedInt(e[o],t):e[o];return n}const en="quantize",tn=[Int8Array,Int16Array,Int32Array],{TRANSLATION:nn,ROTATION:on,SCALE:rn,WEIGHTS:sn}=g.TargetPath,an=[nn,on,rn],cn={pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0};function ln(e=cn){const n=q({},cn,e);return B(en,async e=>{const o=e.getLogger(),r=e.getRoot();let s;e.createExtension(w).setRequired(!0),"scene"===n.quantizationVolume&&(s=un(function(e){const t=e[0];for(const n of e)ue(t.min,t.min,n.min),fe(t.max,t.max,n.max);return t}(r.listMeshes().map(Tn))));for(const t of e.getRoot().listMeshes()){"mesh"===n.quantizationVolume&&(s=un(Tn(t))),s&&n.pattern.test("POSITION")&&(fn(e,t,s),dn(t,1/s.scale));for(const o of t.listPrimitives()){gn(e,o,s,n);for(const t of o.listTargets())gn(e,t,s,n)}}await e.transform(Re({propertyTypes:[t.ACCESSOR,t.SKIN,t.MATERIAL]}),Ee({propertyTypes:[t.ACCESSOR,t.MATERIAL,t.SKIN]})),o.debug(`${en}: Complete.`)})}function gn(t,n,o,r){const s=t.getLogger();for(const t of n.listSemantics()){if(!r.pattern.test(t))continue;const c=n.getAttribute(t),{bits:l,ctor:g}=An(t,c,s,r);if(!g)continue;if(l<8||l>16)throw new Error(`${en}: Requires bits = 8–16.`);if(c.getComponentSize()<=l/8)continue;const u=c.clone();if("POSITION"===t){const t=o.scale,r=[];n instanceof e?ce(r,En(o)):((i=r)[0]=(a=[1/t,1/t,1/t])[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=a[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1);for(let e=0,t=[0,0,0],n=u.getCount();e<n;e++)u.getElement(e,t),u.setElement(e,de(t,t,r))}hn(u,g,l),n.swap(c,u)}var i,a;if(r.normalizeWeights&&n.getAttribute("WEIGHTS_0")&&Jt(n,Infinity),n instanceof e&&n.getIndices()&&n.listAttributes().length&&n.listAttributes()[0].getCount()<65535){const e=n.getIndices();e.setArray(new Uint16Array(e.getArray()))}}function un(e){const{min:t,max:n}=e,o=Math.max((n[0]-t[0])/2,(n[1]-t[1])/2,(n[2]-t[2])/2);return{offset:[t[0]+(n[0]-t[0])/2,t[1]+(n[1]-t[1])/2,t[2]+(n[2]-t[2])/2],scale:o}}function fn(e,t,n){const o=En(n);for(const r of t.listParents()){if(!(r instanceof T))continue;const s=r.listParents().filter(e=>e instanceof g),i=s.some(e=>an.includes(e.getTargetPath())),a=r.listChildren().length>0,c=r.getSkin();if(c){r.setSkin(mn(c,n));continue}const l=r.getExtension("EXT_mesh_gpu_instancing");if(l){r.setExtension("EXT_mesh_gpu_instancing",pn(l,n));continue}let u;a||i?(u=e.createNode("").setMesh(t),r.addChild(u).setMesh(null),s.filter(e=>e.getTargetPath()===sn).forEach(e=>e.setTargetNode(u))):u=r;const f=u.getMatrix();le(f,f,o),u.setMatrix(f)}}function mn(e,t){e=e.clone();const n=En(t),o=e.getInverseBindMatrices().clone(),r=[];for(let e=0,t=o.getCount();e<t;e++)o.getElement(e,r),le(r,r,n),o.setElement(e,r);return e.setInverseBindMatrices(o)}function pn(e,t){var n,o,r;if(!e.getAttribute("TRANSLATION")&&!e.getAttribute("ROTATION")&&!e.getAttribute("SCALE"))return e;const s=null==(n=(e=e.clone()).getAttribute("TRANSLATION"))?void 0:n.clone(),i=null==(o=e.getAttribute("ROTATION"))?void 0:o.clone(),a=null==(r=e.getAttribute("SCALE"))?void 0:r.clone(),c=s||i||a,l=[0,0,0],g=[0,0,0,1],u=[1,1,1],f=[0,0,0],p=[0,0,0,1],d=[1,1,1],h=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],A=En(t);for(let e=0,t=c.getCount();e<t;e++)m.compose(s?s.getElement(e,f):l,i?i.getElement(e,p):g,a?a.getElement(e,d):u,h),le(h,h,A),m.decompose(h,f,p,d),s&&s.setElement(e,f),i&&i.setElement(e,p),a&&a.setElement(e,d);return s&&e.setAttribute("TRANSLATION",s),i&&e.setAttribute("ROTATION",i),a&&e.setAttribute("SCALE",a),e}function dn(e,t){for(const n of e.listPrimitives()){let e=n.getMaterial();if(!e)continue;let o=e.getExtension("KHR_materials_volume");!o||o.getThicknessFactor()<=0||(o=o.clone().setThicknessFactor(o.getThicknessFactor()*t),e=e.clone().setExtension("KHR_materials_volume",o),n.setMaterial(e))}}function hn(e,t,n){const o=new t(e.getArray().length),r=tn.includes(t)?1:0,s=n-r,i=8*t.BYTES_PER_ELEMENT-r,a=Math.pow(2,s)-1,c=i-s,l=2*s-i;for(let t=0,n=0,r=[];t<e.getCount();t++){e.getElement(t,r);for(let e=0;e<r.length;e++){let t=Math.round(Math.abs(r[e])*a);t=t<<c|t>>l,o[n++]=t*Math.sign(r[e])}}e.setArray(o).setNormalized(!0).setSparse(!1)}function An(e,t,n,o){const r=t.getMinNormalized([]),s=t.getMaxNormalized([]);let i,a;if("POSITION"===e)i=o.quantizePosition,a=i<=8?Int8Array:Int16Array;else if("NORMAL"===e||"TANGENT"===e)i=o.quantizeNormal,a=i<=8?Int8Array:Int16Array;else if(e.startsWith("COLOR_"))i=o.quantizeColor,a=i<=8?Uint8Array:Uint16Array;else if(e.startsWith("TEXCOORD_")){if(r.some(e=>e<0)||s.some(e=>e>1))return n.warn(`${en}: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=o.quantizeTexcoord,a=i<=8?Uint8Array:Uint16Array}else{if(e.startsWith("JOINTS_"))return i=Math.max(...t.getMax([]))<=255?8:16,a=i<=8?Uint8Array:Uint16Array,t.getComponentSize()>i/8&&t.setArray(new a(t.getArray())),{bits:-1};if(e.startsWith("WEIGHTS_")){if(r.some(e=>e<0)||s.some(e=>e>1))return n.warn(`${en}: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=o.quantizeWeight,a=i<=8?Uint8Array:Uint16Array}else{if(!e.startsWith("_"))throw new Error(`${en}: Unexpected semantic, "${e}".`);if(r.some(e=>e<-1)||s.some(e=>e>1))return n.warn(`${en}: Skipping ${e}; out of [-1,1] range.`),{bits:-1};i=o.quantizeGeneric,a=a=r.some(e=>e<0)?i<=8?Int8Array:Int16Array:i<=8?Uint8Array:Uint16Array}}return{bits:i,ctor:a}}function Tn(e){const t=[],n=[];for(const o of e.listPrimitives()){const e=o.getAttribute("POSITION");e&&t.push(e);for(const e of o.listTargets()){const t=e.getAttribute("POSITION");t&&n.push(t)}}if(0===t.length)throw new Error(`${en}: Missing "POSITION" attribute.`);const o=yn(t,3);if(n.length>0){const{min:e,max:t}=yn(n,3);ue(o.min,o.min,ue(e,me(e,e,2),[0,0,0])),fe(o.max,o.max,fe(t,me(t,t,2),[0,0,0]))}return o}function yn(e,t){const n=new Array(t).fill(Infinity),o=new Array(t).fill(-Infinity),r=[],s=[];for(const i of e){i.getMinNormalized(r),i.getMaxNormalized(s);for(let e=0;e<t;e++)n[e]=Math.min(n[e],r[e]),o[e]=Math.max(o[e],s[e])}return{min:n,max:o}}function En(e){return o=e.offset,f=(s=(n=[0,0,0,1])[0])*(l=s+s),m=s*(g=(i=n[1])+i),p=s*(u=(a=n[2])+a),h=i*u,T=(c=n[3])*l,y=c*g,E=c*u,M=(r=[e.scale,e.scale,e.scale])[1],I=r[2],(t=[])[0]=(1-((d=i*g)+(A=a*u)))*(S=r[0]),t[1]=(m+E)*S,t[2]=(p-y)*S,t[3]=0,t[4]=(m-E)*M,t[5]=(1-(f+A))*M,t[6]=(h+T)*M,t[7]=0,t[8]=(p+y)*I,t[9]=(h-T)*I,t[10]=(1-(f+d))*I,t[11]=0,t[12]=o[0],t[13]=o[1],t[14]=o[2],t[15]=1,t;var t,n,o,r,s,i,a,c,l,g,u,f,m,p,d,h,A,T,y,E,S,M,I}const Sn={level:"high"},Mn="meshopt";function In(e){const t=q({},Sn,e),n=t.encoder;if(!n)throw new Error(`${Mn}: encoder dependency required — install "meshoptimizer".`);return B(Mn,async e=>{await e.transform(Kt({encoder:n,target:"size"}),ln({pattern:"medium"===t.level?/.*/:/^(POSITION|TEXCOORD|JOINTS|WEIGHTS)(_\d+)?$/,quantizePosition:14,quantizeTexcoord:12,quantizeColor:8,quantizeNormal:8})),e.createExtension(R).setRequired(!0).setEncoderOptions({method:"medium"===t.level?R.EncoderMethod.QUANTIZE:R.EncoderMethod.FILTER})})}const wn="metalRough",bn={};function Nn(e=bn){return q({},bn,e),B(wn,async e=>{const t=e.getLogger();if(!e.getRoot().listExtensionsUsed().map(e=>e.extensionName).includes("KHR_materials_pbrSpecularGlossiness"))return void t.warn(`${wn}: KHR_materials_pbrSpecularGlossiness not found on document.`);const n=e.createExtension(C),o=e.createExtension(O),r=e.createExtension($),s=new Set;for(const t of e.getRoot().listMaterials()){const r=t.getExtension("KHR_materials_pbrSpecularGlossiness");if(!r)continue;const i=o.createSpecular().setSpecularFactor(1).setSpecularColorFactor(r.getSpecularFactor());s.add(r.getSpecularGlossinessTexture()),s.add(t.getBaseColorTexture()),s.add(t.getMetallicRoughnessTexture()),t.setBaseColorFactor(r.getDiffuseFactor()).setMetallicFactor(0).setRoughnessFactor(1).setExtension("KHR_materials_ior",n.createIOR().setIOR(1e3)).setExtension("KHR_materials_specular",i);const a=r.getDiffuseTexture();a&&(t.setBaseColorTexture(a),t.getBaseColorTextureInfo().copy(r.getDiffuseTextureInfo()));const c=r.getSpecularGlossinessTexture();if(c){const n=r.getSpecularGlossinessTextureInfo(),o=e.createTexture();await W(c,o,(e,t,n)=>{e.set(t,n,3,255)}),i.setSpecularTexture(o),i.setSpecularColorTexture(o),i.getSpecularTextureInfo().copy(n),i.getSpecularColorTextureInfo().copy(n);const s=r.getGlossinessFactor(),a=e.createTexture();await W(c,a,(e,t,n)=>{const o=255-Math.round(e.get(t,n,3)*s);e.set(t,n,0,0),e.set(t,n,1,o),e.set(t,n,2,0),e.set(t,n,3,255)}),t.setMetallicRoughnessTexture(a),t.getMetallicRoughnessTextureInfo().copy(n)}else i.setSpecularColorFactor(r.getSpecularFactor()),t.setRoughnessFactor(1-r.getGlossinessFactor());t.setExtension("KHR_materials_pbrSpecularGlossiness",null)}r.dispose();for(const e of s)e&&1===e.listParents().length&&e.dispose();t.debug(`${wn}: Complete.`)})}const Rn="unweld",Cn={};function On(e=Cn){return q({},Cn,e),B(Rn,e=>{const t=e.getLogger(),n=new Map;for(const o of e.getRoot().listMeshes())for(const e of o.listPrimitives()){const o=e.getIndices();if(!o)continue;const r=e.getAttribute("POSITION").getCount();for(const r of e.listAttributes())e.swap(r,$n(r,o,t,n)),1===r.listParents().length&&r.dispose();for(const r of e.listTargets())for(const e of r.listAttributes())r.swap(e,$n(e,o,t,n)),1===e.listParents().length&&e.dispose();const s=e.getAttribute("POSITION").getCount();t.debug(`${Rn}: ${X(r,s)} vertices.`),e.setIndices(null),1===o.listParents().length&&o.dispose()}t.debug(`${Rn}: Complete.`)})}function $n(e,t,n,o){if(o.has(e)&&o.get(e).has(t))return n.debug(`${Rn}: Cache hit for reused attribute, "${e.getName()}".`),o.get(e).get(t);const r=e.clone(),s=e.getArray().constructor;r.setArray(new s(t.getCount()*e.getElementSize()));const i=[];for(let n=0;n<t.getCount();n++)r.setElement(n,e.getElement(t.getScalar(n),i));return o.has(e)||o.set(e,new Map),o.get(e).set(t,r),r}const vn="normals",Pn={overwrite:!1};function xn(e=Pn){const t=q({},Pn,e);return B(vn,async e=>{const n=e.getLogger();let o=0;await e.transform(On());for(const r of e.getRoot().listMeshes())for(const s of r.listPrimitives()){const r=s.getAttribute("POSITION");let i=s.getAttribute("NORMAL");if(t.overwrite&&i)i.dispose();else if(i){n.debug(`${vn}: Skipping primitive: NORMAL found.`);continue}i=e.createAccessor().setArray(new Float32Array(3*r.getCount())).setType("VEC3");const a=[0,0,0],c=[0,0,0],l=[0,0,0];for(let e=0;e<r.getCount();e+=3){r.getElement(e+0,a),r.getElement(e+1,c),r.getElement(e+2,l);const t=Ln(a,c,l);i.setElement(e+0,t),i.setElement(e+1,t),i.setElement(e+2,t)}s.setAttribute("NORMAL",i),o++}o?n.debug(`${vn}: Complete.`):n.warn(`${vn}: No qualifying primitives found. See debug output.`)})}function Ln(e,t,n){const o=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],r=[n[0]-e[0],n[1]-e[1],n[2]-e[2]];return pe([0,0,0],[o[1]*r[2]-o[2]*r[1],o[2]*r[0]-o[0]*r[2],o[0]*r[1]-o[1]*r[0]])}const zn="palette",Fn={blockSize:4,min:2};function _n(e=Fn){const n=q({},Fn,e),o=Math.max(n.blockSize,1),r=Math.max(n.min,1);return B(zn,async e=>{const n=e.getLogger(),s=e.getRoot();await e.transform(Re({keepAttributes:!1,keepLeaves:!0,propertyTypes:[t.ACCESSOR]}));const i=new Set,c=new Set;for(const e of s.listMeshes())for(const t of e.listPrimitives()){const e=t.getMaterial();e&&!t.getAttribute("TEXCOORD_0")&&(i.add(t),c.add(e))}const l=new Set,g=new Map,u={baseColor:new Set,emissive:new Set,metallicRoughness:new Set};for(const e of c){const t=kn(e.getBaseColorFactor().slice()),n=kn([...e.getEmissiveFactor(),1]),o=Gn(e.getRoughnessFactor()),r=Gn(e.getMetallicFactor()),s=`baseColor:${t},emissive:${n},metallicRoughness:${r}${o}`;u.baseColor.add(t),u.emissive.add(n),u.metallicRoughness.add(r+"+"+o),l.add(s),g.set(e,s)}const f=l.size;if(f<r)return void n.debug(`${zn}: Found <${r} unique material properties. Exiting.`);const m=qn(f*o),p=qn(o),d=m-f*o,h={baseColor:null,emissive:null,metallicRoughness:null},A=new Set(["name","extras"]),T=(...e)=>e.forEach(e=>A.add(e));let E=null,S=null,M=null;if(u.baseColor.size>=r){const t="PaletteBaseColor";E=e.createTexture(t).setURI(`${t}.png`),h.baseColor=_(new Uint8Array(m*p*4),[m,p,4]),T("baseColorFactor","baseColorTexture","baseColorTextureInfo")}if(u.emissive.size>=r){const t="PaletteEmissive";S=e.createTexture(t).setURI(`${t}.png`),h.emissive=_(new Uint8Array(m*p*4),[m,p,4]),T("emissiveFactor","emissiveTexture","emissiveTextureInfo")}if(u.metallicRoughness.size>=r){const t="PaletteMetallicRoughness";M=e.createTexture(t).setURI(`${t}.png`),h.metallicRoughness=_(new Uint8Array(m*p*4),[m,p,4]),T("metallicFactor","roughnessFactor","metallicRoughnessTexture","metallicRoughnessTextureInfo")}if(!(E||S||M))return void n.debug(`${zn}: No material property has ≥${r} unique values. Exiting.`);const w=new Set,b=new Map,N=[];let R=0;for(const e of c){const t=g.get(e);if(w.has(t))continue;const n=R++;if(h.baseColor){const t=h.baseColor,r=[...e.getBaseColorFactor()];y.convertLinearToSRGB(r,r),Bn(t,n,r,o)}if(h.emissive){const t=h.emissive,r=[...e.getEmissiveFactor(),1];y.convertLinearToSRGB(r,r),Bn(t,n,r,o)}if(h.metallicRoughness){const t=h.metallicRoughness,r=e.getMetallicFactor();Bn(t,n,[0,e.getRoughnessFactor(),r,1],o)}w.add(t),b.set(t,n)}const C="image/png";if(E){const e=await I(h.baseColor,C);E.setImage(e).setMimeType(C)}if(S){const e=await I(h.emissive,C);S.setImage(e).setMimeType(C)}if(M){const e=await I(h.metallicRoughness,C);M.setImage(e).setMimeType(C)}let O=1;for(const t of i){const n=t.getMaterial(),o=g.get(n),r=(b.get(o)+.5)/f*(m-d)/m,s=t.getAttribute("POSITION"),i=s.getBuffer(),c=new Float32Array(2*s.getCount()).fill(r),l=e.createAccessor().setType("VEC2").setArray(c).setBuffer(i);let u;for(const e of N)e.equals(n,A)&&(u=e);if(!u){const e=(O++).toString().padStart(3,"0");u=n.clone().setName(`PaletteMaterial${e}`),E&&u.setBaseColorFactor([1,1,1,1]).setBaseColorTexture(E).getBaseColorTextureInfo().setMinFilter(a.MinFilter.NEAREST).setMagFilter(a.MagFilter.NEAREST),S&&u.setEmissiveFactor([1,1,1]).setEmissiveTexture(S).getEmissiveTextureInfo().setMinFilter(a.MinFilter.NEAREST).setMagFilter(a.MagFilter.NEAREST),M&&u.setMetallicFactor(1).setRoughnessFactor(1).setMetallicRoughnessTexture(M).getMetallicRoughnessTextureInfo().setMinFilter(a.MinFilter.NEAREST).setMagFilter(a.MagFilter.NEAREST),N.push(u)}t.setMaterial(u).setAttribute("TEXCOORD_0",l)}await e.transform(Re({propertyTypes:[t.MATERIAL]})),n.debug(`${zn}: Complete.`)})}function Gn(e){const t=Math.round(255*e).toString(16);return 1===t.length?"0"+t:t}function kn(e){return y.convertLinearToSRGB(e,e),e.map(Gn).join("")}function qn(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function Bn(e,t,n,o){for(let r=0;r<o;r++)for(let s=0;s<o;s++)e.set(t*o+r,s,0,255*n[0]),e.set(t*o+r,s,1,255*n[1]),e.set(t*o+r,s,2,255*n[2]),e.set(t*o+r,s,3,255*n[3])}const Un="partition",Wn={animations:!0,meshes:!0};function Dn(e=Wn){const n=q({},Wn,e);return B(Un,async e=>{const o=e.getLogger();!1!==n.meshes&&function(e,t,n){const o=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listMeshes().forEach((r,s)=>{if(Array.isArray(n.meshes)&&!n.meshes.includes(r.getName()))return void t.debug(`${Un}: Skipping mesh #${s} with name "${r.getName()}".`);t.debug(`${Un}: Creating buffer for mesh "${r.getName()}".`);const i=e.createBuffer(r.getName()).setURI(Hn(r.getName()||"mesh",o));r.listPrimitives().forEach(e=>{const t=e.getIndices();t&&t.setBuffer(i),e.listAttributes().forEach(e=>e.setBuffer(i)),e.listTargets().forEach(e=>{e.listAttributes().forEach(e=>e.setBuffer(i))})})})}(e,o,n),!1!==n.animations&&function(e,t,n){const o=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listAnimations().forEach((r,s)=>{if(Array.isArray(n.animations)&&!n.animations.includes(r.getName()))return void t.debug(`${Un}: Skipping animation #${s} with name "${r.getName()}".`);t.debug(`${Un}: Creating buffer for animation "${r.getName()}".`);const i=e.createBuffer(r.getName()).setURI(Hn(r.getName()||"animation",o));r.listSamplers().forEach(e=>{const t=e.getInput(),n=e.getOutput();t&&t.setBuffer(i),n&&n.setBuffer(i)})})}(e,o,n),n.meshes||n.animations||o.warn(`${Un}: Select animations or meshes to create a partition.`),await e.transform(Re({propertyTypes:[t.BUFFER]})),o.debug(`${Un}: Complete.`)})}function Hn(e,t){let n=`${e}.bin`,o=1;for(;t.has(n);)n=`${e}_${o++}.bin`;return n}var jn;function Vn(e,t,n){for(let o=0,r=n.length;o<r;o++)n[o]=e[t*r+o];return n}function Xn(e,t,n){for(let o=0,r=n.length;o<r;o++)e[t*r+o]=n[o]}function Kn(e,t,n=0){if(e.length!==t.length)return!1;for(let o=0;o<e.length;o++)if(Math.abs(e[o]-t[o])>n)return!1;return!0}function Jn(e,t,n){return e*(1-n)+t*n}function Zn(e,t,n,o){for(let r=0;r<t.length;r++)e[r]=Jn(t[r],n[r],o);return e}function Qn(e,t,n,o){let r,s,i,a,c,l=t[0],g=t[1],u=t[2],f=t[3],m=n[0],p=n[1],d=n[2],h=n[3];return s=l*m+g*p+u*d+f*h,s<0&&(s=-s,m=-m,p=-p,d=-d,h=-h),1-s>1e-6?(r=Math.acos(s),i=Math.sin(r),a=Math.sin((1-o)*r)/i,c=Math.sin(o*r)/i):(a=1-o,c=o),e[0]=a*l+c*m,e[1]=a*g+c*p,e[2]=a*u+c*d,e[3]=a*f+c*h,e}function Yn(e,t){const n=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}(e,t);return Math.acos(2*n*n-1)}!function(e){e[e.STEP=0]="STEP",e[e.LERP=1]="LERP",e[e.SLERP=2]="SLERP"}(jn||(jn={}));const eo="resample",to=new Float32Array(0),no={ready:Promise.resolve(),resample:function(e,t,n,o=1e-4){const r=t.length/e.length,s=new Array(r).fill(0),i=new Array(r).fill(0),a=new Array(r).fill(0),c=new Array(r).fill(0),l=e.length-1;let g=1;for(let r=1;r<l;++r){const l=e[g-1],u=e[r],f=e[r+1],m=(u-l)/(f-l);let p=!1;if(u!==f&&(1!==r||u!==e[0]))if(Vn(t,g-1,c),Vn(t,r,i),Vn(t,r+1,a),"slerp"===n){const e=Qn(s,c,a,m),t=Yn(c,i)+Yn(i,a);p=!Kn(i,e,o)||t+Number.EPSILON>=Math.PI}else"lerp"===n?p=!Kn(i,Zn(s,c,a,m),o):"step"===n&&(p=!Kn(i,c)||!Kn(i,a));p&&(r!==g&&(e[g]=e[r],Xn(t,g,Vn(t,r,s))),g++)}return l>0&&(e[g]=e[l],Xn(t,g,Vn(t,l,s)),g++),g},tolerance:1e-4};function oo(e=no){const n=q({},no,e);return B(eo,async(e,o)=>{const r=new Set,s=e.getRoot().listAccessors().length,a=e.getLogger(),c=n.ready,l=n.resample;await c;for(const t of e.getRoot().listAnimations()){const e=new Map;for(const n of t.listChannels())e.set(n.getSampler(),n.getTargetPath());for(const o of t.listSamplers()){const t=o.getInterpolation();if("STEP"===t||"LINEAR"===t){const s=o.getInput(),i=o.getOutput();r.add(s),r.add(i);const a=ro(s.getArray(),s.getComponentType(),s.getNormalized()),c=ro(i.getArray(),i.getComponentType(),i.getNormalized()),g=c.length/a.length,u=a.length;let f;if(f="STEP"===t?l(a,c,"step",n.tolerance):"rotation"===e.get(o)?l(a,c,"slerp",n.tolerance):l(a,c,"lerp",n.tolerance),f<u){const e=s.getArray(),t=i.getArray(),n=so(new Float32Array(a.buffer,a.byteOffset,f),s.getComponentType(),s.getNormalized()),r=so(new Float32Array(c.buffer,c.byteOffset,f*g),i.getComponentType(),i.getNormalized());s.setArray(to),i.setArray(to),o.setInput(s.clone().setArray(n)),o.setOutput(i.clone().setArray(r)),s.setArray(e),i.setArray(t)}}}}for(const e of Array.from(r.values()))e.listParents().some(e=>!(e instanceof i))||e.dispose();e.getRoot().listAccessors().length>s&&!U(o,eo,"dedup")&&await e.transform(Ee({propertyTypes:[t.ACCESSOR]})),a.debug(`${eo}: Complete.`)})}function ro(e,t,n){if(e instanceof Float32Array)return e.slice();const o=new Float32Array(e);if(!n)return o;for(let e=0;e<o.length;e++)o[e]=m.decodeNormalizedInt(o[e],t);return o}function so(e,t,n){if(t===u.ComponentType.FLOAT)return e.slice();const o=new(0,d[t])(e.length);for(let r=0;r<o.length;r++)o[r]=n?m.encodeNormalizedInt(e[r],t):e[r];return o}const io="sequence",ao={name:"",fps:10,pattern:/.*/,sort:!0};function co(e=ao){const t=q({},ao,e);return B(io,e=>{const n=e.getLogger(),o=e.getRoot(),r=t.fps,s=o.listNodes().filter(e=>e.getName().match(t.pattern));t.sort&&s.sort((e,t)=>e.getName()>t.getName()?1:-1);const i=e.createAnimation(t.name),a=o.listBuffers()[0];s.forEach((t,n)=>{let o,c;0===n?(o=[n/r,(n+1)/r],c=[1,1,1,0,0,0]):n===s.length-1?(o=[(n-1)/r,n/r],c=[0,0,0,1,1,1]):(o=[(n-1)/r,n/r,(n+1)/r],c=[0,0,0,1,1,1,0,0,0]);const l=e.createAccessor().setArray(new Float32Array(o)).setBuffer(a),f=e.createAccessor().setArray(new Float32Array(c)).setBuffer(a).setType(u.Type.VEC3),m=e.createAnimationSampler().setInterpolation(E.Interpolation.STEP).setInput(l).setOutput(f),p=e.createAnimationChannel().setTargetNode(t).setTargetPath(g.TargetPath.SCALE).setSampler(m);i.addSampler(m).addChannel(p)}),n.debug(`${io}: Complete.`)})}const lo="simplify",go={ratio:0,error:1e-4,lockBorder:!1};function uo(n){const o=q({},go,n),r=o.simplifier;if(!r)throw new Error(`${lo}: simplifier dependency required — install "meshoptimizer".`);return B(lo,async(n,s)=>{const i=n.getLogger();await r.ready,await n.transform(Le({overwrite:!1}));for(const t of n.getRoot().listMeshes()){for(const r of t.listPrimitives())r.getMode()===e.Mode.TRIANGLES?(fo(n,r,o),0===r.getIndices().getCount()&&r.dispose()):i.warn(`${lo}: Skipping primitive of mesh "${t.getName()}": Requires TRIANGLES draw mode.`);0===t.listPrimitives().length&&t.dispose()}await n.transform(Re({keepLeaves:!1,propertyTypes:[t.ACCESSOR,t.NODE]})),U(s,lo,"dedup")||await n.transform(Ee({propertyTypes:[t.ACCESSOR]})),i.debug(`${lo}: Complete.`)})}function fo(e,t,n){const o=q({},go,n),r=o.simplifier,s=e.getLogger(),i=t.getAttribute("POSITION"),a=t.getIndices(),c=i.getCount();let l=i.getArray(),g=a.getArray();if(i.getComponentType()!==u.ComponentType.FLOAT)if(i.getNormalized()){const e=l,t=new Float32Array(e.length);for(let n=0,o=i.getCount(),r=[];n<o;n++)r=i.getElement(n,r),i.setArray(t).setElement(n,r).setArray(e);l=t}else l=new Float32Array(l);a.getComponentType()!==u.ComponentType.UNSIGNED_INT&&(g=new Uint32Array(g));const f=3*Math.floor(o.ratio*c/3),[m,p]=r.simplify(g,l,3,f,o.error,o.lockBorder?["LockBorder"]:[]),[d,h]=r.compactMesh(m);s.debug(`${lo}: ${X(i.getCount(),h)} vertices, error: ${p.toFixed(4)}.`);for(const e of K(t)){const n=e.clone();Q(n,d,h),J(t,e,n),1===e.listParents().length&&e.dispose()}const A=a.clone();return A.setArray(c<=65534?new Uint16Array(m):m),t.setIndices(A),1===a.listParents().length&&a.dispose(),t}const mo="sparse",po={ratio:1/3};function ho(e=po){const t=q({},po,e).ratio;if(t<0||t>1)throw new Error(`${mo}: Ratio must be between 0 and 1.`);return B(mo,e=>{const n=e.getRoot(),o=e.getLogger();let r=0;for(const e of n.listAccessors()){const n=e.getCount(),o=Array(e.getElementSize()).fill(0),s=Array(e.getElementSize()).fill(0);let i=0;for(let r=0;r<n&&(e.getElement(r,s),m.eq(s,o,0)||i++,!(i/n>=t));r++);const a=i/n<t;a!==e.getSparse()&&(e.setSparse(a),r++)}o.debug(`${mo}: Updated ${r} accessors.`),o.debug(`${mo}: Complete.`)})}const Ao="textureResize";var To;!function(e){e.LANCZOS3="lanczos3",e.LANCZOS2="lanczos2"}(To||(To={}));const yo={size:[2048,2048],filter:To.LANCZOS3,pattern:null,slots:null};function Eo(e=yo){const t=q({},yo,e);return B(Ao,async e=>{const n=e.getLogger();for(const o of e.getRoot().listTextures()){const e=o.getName(),r=o.getURI();if(t.pattern&&!t.pattern.test(e)&&!t.pattern.test(r)){n.debug(`${Ao}: Skipping, excluded by "pattern" parameter.`);continue}if("image/png"!==o.getMimeType()&&"image/jpeg"!==o.getMimeType()){n.warn(`${Ao}: Skipping, unsupported texture type "${o.getMimeType()}".`);continue}const s=jt(o);if(t.slots&&!s.some(e=>{var n;return null==(n=t.slots)?void 0:n.test(e)})){n.debug(`${Ao}: Skipping, [${s.join(", ")}] excluded by "slots" parameter.`);continue}const i=o.getSize(),a=te(i,t.size);if(m.eq(i,a)){n.debug(`${Ao}: Skipping, not within size range.`);continue}const c=o.getImage(),l=await M(c,o.getMimeType()),g=_(new Uint8Array(a[0]*a[1]*4),[...a,4]);n.debug(`${Ao}: Resizing "${r||e}", ${l.shape} → ${g.shape}...`),n.debug(`${Ao}: Slots → [${s.join(", ")}]`);try{t.filter===To.LANCZOS3?G(l,g):k(l,g)}catch(t){if(t instanceof Error){n.warn(`${Ao}: Failed to resize "${r||e}": "${t.message}".`);continue}throw t}o.setImage(await I(g,o.getMimeType()))}n.debug(`${Ao}: Complete.`)})}const So="textureCompress",Mo=["jpeg","png","webp","avif"],Io=["image/jpeg","image/png","image/webp","image/avif"],wo={resizeFilter:To.LANCZOS3,pattern:void 0,formats:void 0,slots:void 0,quality:void 0,effort:void 0,lossless:!1,nearLossless:!1};function bo(e){const t=q({},wo,e),n=t.targetFormat,o=t.pattern,r=t.formats,s=t.slots;return B(So,async e=>{const i=e.getLogger(),a=e.getRoot().listTextures();await Promise.all(a.map(async(a,c)=>{const l=jt(a),g=Ht(a),u=a.getURI()||a.getName()||`${c+1}/${e.getRoot().listTextures().length}`,f=`${So}(${u})`;if(!Io.includes(a.getMimeType()))return void i.debug(`${f}: Skipping, unsupported texture type "${a.getMimeType()}".`);if(o&&!o.test(a.getName())&&!o.test(a.getURI()))return void i.debug(`${f}: Skipping, excluded by "pattern" parameter.`);if(r&&!r.test(a.getMimeType()))return void i.debug(`${f}: Skipping, "${a.getMimeType()}" excluded by "formats" parameter.`);if(s&&l.length&&!l.some(e=>s.test(e)))return void i.debug(`${f}: Skipping, [${l.join(", ")}] excluded by "slots" parameter.`);if("jpeg"===t.targetFormat&&g&h.A)return void i.warn(`${f}: Skipping, [${l.join(", ")}] requires alpha channel.`);const m=Ro(a);i.debug(`${f}: Format = ${m} → ${n||m}`),i.debug(`${f}: Slots = [${l.join(", ")}]`);const p=a.getImage(),d=p.byteLength;await No(a,t);const A=a.getImage(),T=A.byteLength,y=p===A?" (SKIPPED":"";i.debug(`${f}: Size = ${j(d)} → ${j(T)}${y}`)}));const c=e.createExtension(v);a.some(e=>"image/webp"===e.getMimeType())?c.setRequired(!0):c.dispose();const l=e.createExtension(P);a.some(e=>"image/avif"===e.getMimeType())?l.setRequired(!0):l.dispose(),i.debug(`${So}: Complete.`)})}async function No(e,t){const n=q({},wo,t),o=n.encoder,r=Ro(e),i=n.targetFormat||r,a=e.getMimeType(),c=`image/${i}`,l=e.getImage(),g=o?await async function(e,t,n,o){const r=o.encoder;let i={};const a=Co(n);switch(a){case"jpeg":i={quality:o.quality};break;case"png":i={quality:o.quality,effort:Oo(o.effort,100,10)};break;case"webp":i={quality:o.quality,effort:Oo(o.effort,100,6),lossless:o.lossless,nearLossless:o.nearLossless};break;case"avif":i={quality:o.quality,effort:Oo(o.effort,100,9),lossless:o.lossless}}const c=r(e).toFormat(a,i);return o.resize&&c.resize(o.resize[0],o.resize[1],{fit:"inside",kernel:o.resizeFilter,withoutEnlargement:!0}),s.toView(await c.toBuffer())}(l,0,c,n):await async function(e,t,n,o){const r=await M(e,t);if(o.resize){const[e,t]=r.shape,s=te([e,t],o.resize),i=_(new Uint8Array(s[0]*s[1]*4),[...s,4]);return o.resizeFilter===To.LANCZOS3?G(r,i):k(r,i),I(i,n)}return I(r,n)}(l,a,c,n);if(!(a===c&&g.byteLength>=l.byteLength)||n.resize)if(a===c)e.setImage(g);else{const t=p.mimeTypeToExtension(a),n=p.mimeTypeToExtension(c),o=e.getURI().replace(new RegExp(`\\.${t}$`),`.${n}`);e.setImage(g).setMimeType(c).setURI(o)}}function Ro(e){return Co(e.getMimeType())}function Co(e){const t=e.split("/").pop();if(!t||!Mo.includes(t))throw new Error(`Unknown MIME type "${e}".`);return t}function Oo(e,t,n){if(null!=e)return Math.round(e/t*n)}const $o="tangents",vo={overwrite:!1};function Po(e=vo){if(!e.generateTangents)throw new Error(`${$o}: generateTangents callback required — install "mikktspace".`);const t=q({},vo,e);return B($o,e=>{const n=e.getLogger(),o=new Map,r=new Map;let s=0;for(const i of e.getRoot().listMeshes()){const a=i.getName(),c=i.listPrimitives();for(let i=0;i<c.length;i++){const l=c[i];if(!Lo(l,n,a,i,t.overwrite))continue;const g=xo(l),u=l.getAttribute("POSITION").getArray(),f=l.getAttribute("NORMAL").getArray(),m=l.getAttribute(g).getArray(),p=o.get(u)||S();o.set(u,p);const d=o.get(f)||S();o.set(f,d);const h=o.get(m)||S();o.set(m,h);const A=l.getAttribute("TANGENT");A&&2===A.listParents().length&&A.dispose();const T=`${p}|${d}|${h}`;let y=r.get(T);if(y){n.debug(`${$o}: Found cache for primitive ${i} of mesh "${a}".`),l.setAttribute("TANGENT",y),s++;continue}n.debug(`${$o}: Generating for primitive ${i} of mesh "${a}".`);const E=l.getAttribute("POSITION").getBuffer(),M=t.generateTangents(u instanceof Float32Array?u:new Float32Array(u),f instanceof Float32Array?f:new Float32Array(f),m instanceof Float32Array?m:new Float32Array(m));for(let e=3;e<M.length;e+=4)M[e]*=-1;y=e.createAccessor().setBuffer(E).setArray(M).setType("VEC4"),l.setAttribute("TANGENT",y),r.set(T,y),s++}}s?n.debug(`${$o}: Complete.`):n.warn(`${$o}: No qualifying primitives found. See debug output.`)})}function xo(e){const t=e.getMaterial();if(!t)return"TEXCOORD_0";const n=t.getNormalTextureInfo();if(!n)return"TEXCOORD_0";const o=`TEXCOORD_${n.getTexCoord()}`;return e.getAttribute(o)?o:"TEXCOORD_0"}function Lo(t,n,o,r,s){return t.getMode()===e.Mode.TRIANGLES&&t.getAttribute("POSITION")&&t.getAttribute("NORMAL")&&t.getAttribute("TEXCOORD_0")?t.getAttribute("TANGENT")&&!s?(n.debug(`${$o}: Skipping primitive ${r} of mesh "${o}": TANGENT found.`),!1):!t.getIndices()||(n.warn(`${$o}: Skipping primitive ${r} of mesh "${o}": primitives must be unwelded.`),!1):(n.debug(`${$o}: Skipping primitive ${r} of mesh "${o}": primitives must have attributes=[POSITION, NORMAL, TEXCOORD_0] and mode=TRIANGLES.`),!1)}function zo(){return e=>{const t=e.createExtension(x).createUnlit();e.getRoot().listMaterials().forEach(e=>{e.setExtension("KHR_materials_unlit",t)})}}const Fo="unpartition",_o={};function Go(e=_o){return q({},_o,e),B(Fo,async e=>{const t=e.getLogger(),n=e.getRoot().listBuffers()[0];e.getRoot().listAccessors().forEach(e=>e.setBuffer(n)),e.getRoot().listBuffers().forEach((e,t)=>t>0?e.dispose():null),t.debug(`${Fo}: Complete.`)})}const ko="vertexColorSpace",qo=Bo;function Bo(e){return B(ko,t=>{const n=t.getLogger(),o=(e.inputColorSpace||e.inputEncoding||"").toLowerCase();if("srgb-linear"===o)return void n.info(`${ko}: Vertex colors already linear. Skipping conversion.`);if("srgb"!==o)return void n.error(`${ko}: Unknown input color space "${o}" – should be "srgb" or "srgb-linear". Skipping conversion.`);const r=new Set;function s(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function i(e){const t=[0,0,0];let n;for(let o=0;n=e.getAttribute(`COLOR_${o}`);o++)if(!r.has(n)){for(let e=0;e<n.getCount();e++)n.getElement(e,t),t[0]=s(t[0]),t[1]=s(t[1]),t[2]=s(t[2]),n.setElement(e,t);r.add(n)}}t.getRoot().listMeshes().forEach(e=>e.listPrimitives().forEach(i)),n.debug(`${ko}: Complete.`)})}export{ot as DRACO_DEFAULTS,it as FLATTEN_DEFAULTS,Gt as JOIN_DEFAULTS,Sn as MESHOPT_DEFAULTS,Fn as PALETTE_DEFAULTS,cn as QUANTIZE_DEFAULTS,go as SIMPLIFY_DEFAULTS,wo as TEXTURE_COMPRESS_DEFAULTS,yo as TEXTURE_RESIZE_DEFAULTS,To as TextureResizeFilter,xe as WELD_DEFAULTS,re as center,ie as clearNodeParent,Ze as clearNodeTransform,qo as colorspace,No as compressTexture,B as createTransform,Ee as dedup,et as dequantize,tt as dequantizePrimitive,rt as draco,at as flatten,D as getGLPrimitiveCount,ct as getNodeScene,Ht as getTextureChannelMask,gt as getTextureColorSpace,ut as inspect,It as instance,U as isTransformPending,kt as join,Ot as joinPrimitives,se as listNodeScenes,Dt as listTextureChannels,Ie as listTextureInfo,we as listTextureInfoByMaterial,jt as listTextureSlots,In as meshopt,Nn as metalRough,xn as normals,_n as palette,Dn as partition,Re as prune,ln as quantize,Kt as reorder,oo as resample,co as sequence,uo as simplify,fo as simplifyPrimitive,Jt as sortPrimitiveWeights,ho as sparse,Po as tangents,bo as textureCompress,Eo as textureResize,Ke as transformMesh,He as transformPrimitive,zo as unlit,Go as unpartition,On as unweld,Bo as vertexColorSpace,Le as weld,ze as weldPrimitive};
//# sourceMappingURL=functions.modern.js.map
