{"version":3,"file":"ndarray-pixels-node.cjs","sources":["../src/node-get-pixels.ts","../src/common.ts","../src/node-save-pixels.ts","../src/index.ts"],"sourcesContent":["import ndarray, { NdArray } from 'ndarray';\nimport sharp from 'sharp';\n\nexport async function getPixelsInternal(\n\tbuffer: Uint8Array,\n\t_mimeType: string\n): Promise<NdArray<Uint8Array>> {\n\t// Warn for Data URIs, URLs, and file paths. Support removed in v3.\n\tif (!(buffer instanceof Uint8Array)) {\n\t\tthrow new Error('[ndarray-pixels] Input must be Uint8Array or Buffer.');\n\t}\n\n\tconst { data, info } = await sharp(buffer)\n\t\t.ensureAlpha()\n\t\t.raw()\n\t\t.toBuffer({ resolveWithObject: true });\n\n\treturn ndarray(\n\t\tnew Uint8Array(data),\n\t\t[info.width, info.height, 4],\n\t\t[4, (4 * info.width) | 0, 1],\n\t\t0\n\t);\n}\n","import ndarray, { NdArray } from 'ndarray';\nimport ops from 'ndarray-ops';\n\nexport function putPixelData(\n\tarray: NdArray<Uint8Array | Uint8ClampedArray>,\n\tdata: Uint8Array | Uint8ClampedArray,\n\tframe = -1\n): Uint8Array | Uint8ClampedArray {\n\tif (array.shape.length === 4) {\n\t\treturn putPixelData(array.pick(frame), data, 0);\n\t} else if (array.shape.length === 3) {\n\t\tif (array.shape[2] === 3) {\n\t\t\tops.assign(\n\t\t\t\tndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]),\n\t\t\t\tarray\n\t\t\t);\n\t\t\tops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n\t\t} else if (array.shape[2] === 4) {\n\t\t\tops.assign(\n\t\t\t\tndarray(data, [array.shape[0], array.shape[1], 4], [4, array.shape[0] * 4, 1]),\n\t\t\t\tarray\n\t\t\t);\n\t\t} else if (array.shape[2] === 1) {\n\t\t\tops.assign(\n\t\t\t\tndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]),\n\t\t\t\tndarray(\n\t\t\t\t\tarray.data,\n\t\t\t\t\t[array.shape[0], array.shape[1], 3],\n\t\t\t\t\t[array.stride[0], array.stride[1], 0],\n\t\t\t\t\tarray.offset\n\t\t\t\t)\n\t\t\t);\n\t\t\tops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n\t\t} else {\n\t\t\tthrow new Error('[ndarray-pixels] Incompatible array shape.');\n\t\t}\n\t} else if (array.shape.length === 2) {\n\t\tops.assign(\n\t\t\tndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]),\n\t\t\tndarray(\n\t\t\t\tarray.data,\n\t\t\t\t[array.shape[0], array.shape[1], 3],\n\t\t\t\t[array.stride[0], array.stride[1], 0],\n\t\t\t\tarray.offset\n\t\t\t)\n\t\t);\n\t\tops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n\t} else {\n\t\tthrow new Error('[ndarray-pixels] Incompatible array shape.');\n\t}\n\treturn data;\n}\n","import { NdArray } from 'ndarray';\nimport sharp, { AvailableFormatInfo } from 'sharp';\nimport { putPixelData } from './common';\n\nexport async function savePixelsInternal(\n\tpixels: NdArray<Uint8Array | Uint8ClampedArray>,\n\tmimeType: string\n): Promise<Uint8Array> {\n\tconst [width, height, channels] = pixels.shape as [number, number, 4];\n\tconst data = putPixelData(pixels, new Uint8Array(width * height * channels));\n\tconst format = mimeType.replace('image/', '') as unknown as AvailableFormatInfo;\n\treturn sharp(data, { raw: { width, height, channels } }).toFormat(format).toBuffer();\n}\n","import type { NdArray } from 'ndarray';\nimport { getPixelsInternal } from './node-get-pixels';\nimport { savePixelsInternal } from './node-save-pixels';\n\n/**\n * Decodes image data to an `ndarray`.\n *\n * MIME type is optional when given a path or URL, and required when given a Uint8Array.\n *\n * Accepts `image/png` or `image/jpeg` in Node.js, and additional formats on browsers with\n * the necessary support in Canvas 2D.\n *\n * @param data\n * @param mimeType `image/jpeg`, `image/png`, etc.\n * @returns\n */\nasync function getPixels(data: Uint8Array, mimeType: string): Promise<NdArray<Uint8Array>> {\n\treturn getPixelsInternal(data, mimeType);\n}\n\n/**\n * Encodes an `ndarray` as image data in the given format.\n *\n * If the source `ndarray` was constructed manually with default stride, use\n * `ndarray.transpose(1, 0)` to reshape it and ensure an identical result from getPixels(). For an\n * ndarray created by getPixels(), this isn't necessary.\n *\n * Accepts `image/png` or `image/jpeg` in Node.js, and additional formats on browsers with\n * the necessary support in Canvas 2D.\n *\n * @param pixels ndarray of shape W x H x 4.\n * @param mimeType `image/jpeg`, `image/png`, etc.\n * @returns\n */\nasync function savePixels(\n\tpixels: NdArray<Uint8Array | Uint8ClampedArray>,\n\tmimeType: string\n): Promise<Uint8Array> {\n\treturn savePixelsInternal(pixels, mimeType);\n}\n\nexport { getPixels, savePixels };\n"],"names":["getPixelsInternal","buffer","_mimeType","Uint8Array","Error","data","info","sharp","ensureAlpha","raw","toBuffer","resolveWithObject","ndarray","width","height","putPixelData","array","frame","shape","length","pick","ops","assign","assigns","stride","offset","savePixelsInternal","pixels","mimeType","channels","format","replace","toFormat","getPixels","savePixels"],"mappings":"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"}